<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <style>
      table#resultsTable {
        width: 100%; 
        background-color: #f1f1c1;
        border: 1;
        align: center;
      }
    </style>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      <div id="dateSelect" style="float: right;"></div>
      <div style="clear: both;"></div>
    </div>
    <div>
      <table id="resultsTable"></table>
    </div>
    
    <script>
    
    var dateSelect  = $('#dateSelect').MPDatepicker();
    
    var params = {
          from: '2015-01-01',
          to: '2015-04-30',
          type: 'general',
          unit: 'day',
          limit: 1
        };
    
    var queryNav = function() {
      
      $("table#resultsTable tr").remove(); 
      
      var dateRange = dateSelect.MPDatepicker('value');
        
      params['from'] = dateRange.from.toISOString().substring(0, 10);
      params['to'] = dateRange.to.toISOString().substring(0, 10);
      if(params['where']){
        params.delete['where'];
      }
      
      promiselist = [];
      if(dateRange) {
        promiselist.push(MP.api.segment("Skill Review", "$email", params).done(function(results){ return results.values(); }));
        
        Promise.all(promiselist).then(function(promiseArray){
          calculateResults(promiseArray);
        });
      }
    }
    
    var calculateResults = function(data) {
      $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Email" + '</td>' +
            '<td>' + "Date" + '</td>' +
            '<td>' + "Skill" + '</td>' +
            '<td>' + "Rating" + '</td>' +
            '<td>' + "Review" + '</td>' +
            '</tr>'
          );
      $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "---" + '</td>' +
            '<td>' + "---" + '</td>' +
            '<td>' + "---" + '</td>' +
            '<td>' + "---" + '</td>' +
            '<td>' + "---" + '</td>' +
            '</tr>'
          );
          
      promiselist = [];
      var segment = data[0].values();
      console.log(segment);
      var keys = Object.keys(segment);
      for(i=0; i<keys.length; i++){
        var dates = Object.keys(segment[keys[i]]);
        for(j=0; j<dates.length; j++){
          promiselist.push(processResults(keys[i], dates[j], segment[keys[i]][dates[j]]));
        }
      }

      Promise.all(promiselist).then(function(promiseArray){
        console.log(promiseArray);
        var total = 0;
        for(i=0; i<promiseArray.length; i++){
          total += promiseArray[i];
        }
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Activity" + '</td>' +
            '<td>' + "Count" + '</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "---" + '</td>' +
            '<td>' + "---" + '</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Video Watched" + '</td>' +
            '<td>' + promiseArray[0]/total*100 + '%</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Review Watched" + '</td>' +
            '<td>' + promiseArray[1]/total*100 + '%</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Video Recorded" + '</td>' +
            '<td>' + promiseArray[2]/total*100 + '%</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Video Shared" + '</td>' +
            '<td>' + promiseArray[3]/total*100 + '%</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Comment Posted" + '</td>' +
            '<td>' + promiseArray[4]/total*100 + '%</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Review Posted" + '</td>' +
            '<td>' + promiseArray[5]/total*100 + '%</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Paid for Review" + '</td>' +
            '<td>' + promiseArray[6]/total*100 + '%</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "---" + '</td>' +
            '<td>' + "---" + '</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Active Posters" + '</td>' +
            '<td>' + promiseArray[3] + '</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Active Commenters" + '</td>' +
            '<td>' + promiseArray[4] + '</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "New Accounts" + '</td>' +
            '<td>' + promiseArray[7] + '</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Active Reviewers" + '</td>' +
            '<td>' + promiseArray[8] + '</td>' +
            '</tr>'
          );
        $('table#resultsTable').append(
            '<tr>' +
            '<td>' + "Active Users" + '</td>' +
            '<td>' + promiseArray[9] + '</td>' +
            '</tr>'
          );
      });
    }
    
    //return flat object of: email, date, skill, rating, review
    var processResults = function(email, date, results) {
      var returnObj = [];
      var promiselist = [];
      params['where'] = '(properties["$email"] == "' + email + '")';
      params['to'] = date;
      params['from'] = date;
      returnObj.push(email);
      returnObj.push(date);
      promiselist.push(MP.api.segment("Skill Review", "skill_name_en", params).done(function(results){ return results.values(); }));
      promiselist.push(MP.api.segment("Skill Review", "rating_num", params).done(function(results){ return results.values(); }));
      promiselist.push(MP.api.segment("Skill Review", "review", params).done(function(results){ return results.values(); }));
      
      Promise.all(promiselist).then(function(promiseArray){
        console.log(promiseArray);
        var skill = promiseArray[0].values();
        console.log(skill);
        var skillkey = Object.keys(skill);
        var rating = promiseArray[1].values();
        console.log(rating);
        var ratingkey = Object.keys(ratingkey);
        var review = promiseArray[2].values();
        console.log(review);
        var reviewkey = Obkect.keys(review);
        returnObj.push(skillkey[0]);
        returnObj.push(ratingkey[0]);
        returnObj.push(reviewkey[0]);
        console.log(returnObj);
        return returnObj;
      });
    }
    
    queryNav();
    dateSelect.on('change', queryNav);
     
    </script>
  </body>
</html>
